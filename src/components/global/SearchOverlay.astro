---
import Cards from "components/global/Cards.astro";
import { allProducts, type Product } from "libs/allProducts";
import { Search } from "lucide-astro";

const products: Product[] = allProducts;

const buildSearchData = (p: Product) =>
  [
    p.title,
    p.alt,
    p.altlogo,
    p.description,
    p.typeMotor,
    p.typeMotor1,
    p.source,
    p.categoryId,
  ]
    .filter(Boolean)
    .join(" ")
    .toLowerCase();

const getProductHref = (p: Product) => {
  if (!p.configKey) return undefined;

  // Lien externe (Amazon, MyCover, etc.)
  if (p.configKey.startsWith("http")) {
    return p.configKey;
  }

  // Config AllDays
  if (p.source === "config-allDays") {
    return `/product/config?config=${encodeURIComponent(p.configKey)}#item-1`;
  }

  // Config Compétition
  if (p.source === "config-competition") {
    return `/product/config?configCompetition=${encodeURIComponent(
      p.configKey
    )}#item-1`;
  }

  // Fiche produit interne
  if (p.source === "produit") {
    return `/product/produit?produit=${encodeURIComponent(p.configKey)}`;
  }

  // Fallback
  return `/product/produit?produit=${encodeURIComponent(p.configKey)}`;
};

const isExternal = (p: Product) =>
  !!p.configKey && p.configKey.startsWith("http");
---

<!-- Overlay global de recherche -->
<div
  data-search-overlay
  class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200"
>
  <div
    class="absolute inset-0 flex flex-col items-center pt-28 px-4 lg:px-10"
  >
    <!-- Boîte principale -->
    <div
      data-search-container
      class="w-full max-w-7xl bg-[#0f1015] rounded-3xl border border-orange-400/40 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]"
    >
      <!-- Header overlay -->
      <div class="flex items-center gap-3 px-5 py-4 border-b border-white/10">
        <div class="flex-1 flex items-center gap-3 bg-[#151624] rounded-full px-4 py-2">
          <Search class="w-5 h-5 text-orange-400"/>
          <input
            data-search-input
            type="search"
            placeholder="Rechercher une config, une pièce, une catégorie… (ex : 70cc, Airsal, kit déco, casque)"
            class="bg-transparent outline-none text-sm lg:text-base text-white placeholder:text-gray-400 flex-1"
          />
        </div>
        <button
          type="button"
          data-search-close
          class="text-gray-300 hover:text-white text-sm px-3 py-1 rounded-full border border-white/10 hover:border-white/40"
        >
          Échap
        </button>
      </div>

      <!-- Infos -->
      <div class="px-5 py-2 text-xs text-gray-400 flex items-center justify-between gap-2">
        <p>
          <span data-search-count>{products.length}</span>
          {" "}résultat(s) disponible(s)
        </p>
        <p class="hidden sm:block">
          Astuce : tape une marque (<span class="text-orange-400">Airsal</span>),
          une cylindrée (<span class="text-orange-400">70cc</span>),
          ou une catégorie (<span class="text-orange-400">casque</span>, <span class="text-orange-400">kit déco</span>…)
        </p>
      </div>

      <!-- Résultats -->
      <div class="px-5 pb-4 overflow-y-auto">
        <div
          data-search-results
          class="grid gap-4 md:gap-6 grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 py-3 mt-4"
        >
          {products.map((p) => {
            const searchData = buildSearchData(p);
            const imageSrc = p.image
              ? `/images/${p.image}`
              : "/images/moteur.png";
            const logoSrc = p.logo
              ? (p.logo.startsWith("/images") ? p.logo : `/images/${p.logo}`)
              : "/images/logo2.svg";
            const lien = getProductHref(p);
            const external = isExternal(p);

            return (
              <article
                class="product-card"
                data-search={searchData}
              >
                <Cards
                  title={p.title}
                  description={p.description ?? ""}
                  price={p.price && p.price !== "N/A" ? p.price : undefined}
                  imageSrc={imageSrc}
                  lien={lien}
                  logo={logoSrc}
                  typeMotor={p.typeMotor}
                  typeMotor1={p.typeMotor1}
                  alt={p.alt ?? p.title}
                  altLogo={p.altlogo ?? p.alt ?? p.title}
                  external={external}
                />
              </article>
            );
          })}

        <article
            class="product-card"
            data-search="esthetique esthétique kit déco deco perso peinture impression 3d carbone gxs lmr of carbon tuning design custom"
        >
            <Cards
                title="Esthétique"
                description="Personnalisation, kits décos, carbone, impression 3D et partenaires."
                imageSrc="/images/pedroni-search.png"
                lien="/categorie/esthetique"
                logo="/images/logo2.svg"
                alt="Page esthétique"
                altLogo="Esthétique"
                external={false}
            />
        </article>
        <article
            class="product-card"
            data-search="equipement casque gants blouson bottes combinaison tenue cross protection sécurité"
        >
            <Cards
                title="Équipement"
                description="Casques, gants, blousons, bottes et tous les équipements moto."
                imageSrc="/images/equipement-search.png"
                lien="/categorie/equipement"
                logo="/images/logo2.svg"
                alt="Page équipement"
                altLogo="Équipement"
                external={false}
            />
        </article>
        <article
            class="product-card"
            data-search="GXS Racing - Personnalise ta moto avec un kit déco UNIQUE ! Code -10% SPCODE_XARUO"
        >
            <Cards
                title="Kits décos -10%"
                alt="kit déco perso"
                logo="/images/gxs.jpg"
                description="GXS Racing - Personnalise ta moto avec un kit déco UNIQUE ! Code -10% SPCODE_XARUO"
                imageSrc="/images/lucas.png"
                lien="https://gxs-racing.com/fr/?refs=8350"
                        external="true"
            />
        </article>
        <article
            class="product-card"
            data-search="LMR 3D Objet cassé, pièce rare ou création sur mesure ? Nous concevons et imprimons en 3D tout ce dont vous avez besoin."
        >
            <Cards
                title="Impression 3d"
                alt="LMR 3D"
                logo="/images/lmr.png"
                description="LMR 3D Objet cassé, pièce rare ou création sur mesure ? Nous concevons et imprimons en 3D tout ce dont vous avez besoin."
                imageSrc="/images/cacheAllumage.png"
                lien="https://www.lmr3d.com/?ref=TTP"
                external="true"
            />
        </article>
        <article
            class="product-card"
            data-search="OF Carbon fabiquant de pièces carbone tissé / brut / forged"
        >
        <Cards
            title="Fabriquant Carbone"
            alt="moulage Carbone"
            logo="/images/of.jpg"
            description="OF Carbon fabiquant de pièces carbone tissé / brut / forged"
            imageSrc="/images/carbone.png"
            lien="https://www.instagram.com/of_carbon/"
            external="true"
        />
        </article>
        <!-- <article
            class="product-card"
            data-search="Pièce tailler masse usinage"
        >
            <Cards
                title = "Pièce tailler masse"
                alt = "pièce tailler masse"
                logo="/images/logo2.svg"
                description = "Pièces massives, style inimitable : le sur-mesure à l’état brut."
                imageSrc = "/images/t.png"
                lien = ""
                external="true"
            />
        </article>-->
        <article
            class="product-card"
            data-search="pneu slick pmt"
        >
            <Cards
                title = "Slick"
                alt = "pneu slick"
                logo="/images/logo2.svg"
                description = "Le grip ultime pour maîtriser chaque virage."
                imageSrc = "/images/pneu-pmt.png"
                lien = ""
                external="true"
            />
        </article>
		<article
			class="product-card"
			data-search="traceur gps monimoto anti-vol antivol"
		>
			<Cards
				title = "Traceur GPS Moto"
				alt = "Traceur GPS Moto"
				logo="/images/monimoto.svg"
				description = "Traceur GPS anti-vol sans fil pour moto."
				imageSrc = "/images/traceur.png"
				lien = "https://monimoto.com/fr/ride/417/"
				external="true"
			/>
		</article>
		<article
			class="product-card"
			data-search="muc off muc-off nettoyage entretien nettoyeur haute pression"
		>
			<Cards
				title = "Tout pour le nettoyage et l'entretien"
				alt = "Tout pour le nettoyage et l'entretien"
				logo="/images/muc-logo.png"
				description = "Nettoyeur haute préssion ? Produit d'entretien/nettoyage. Tout se trouve ici !"
				imageSrc = "/images/nettoyage.png"
				lien = "https://mucoff.sjv.io/Xmb7Gb"
				external="true"
			/>
		</article>
    </div>
        <p
          data-search-empty
          class="hidden text-center text-sm text-gray-400 py-4"
        >
          Aucun résultat ne correspond à ta recherche. Essaie avec d'autres mots
          (ex : <span class="text-orange-400">Airsal</span>, <span class="text-orange-400">Bidalot</span>,
          <span class="text-orange-400">casque</span>, <span class="text-orange-400">kit déco</span>…)
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  const overlay = document.querySelector("[data-search-overlay]");
  const container = overlay?.querySelector("[data-search-container]"); 
  const input = overlay?.querySelector("[data-search-input]");
  const resultsContainer = overlay?.querySelector("[data-search-results]");
  const cards = resultsContainer
    ? Array.from(resultsContainer.querySelectorAll(".product-card"))
    : [];
  const countEl = overlay?.querySelector("[data-search-count]");
  const emptyEl = overlay?.querySelector("[data-search-empty]");

  function openSearch() {
    if (!overlay) return;
    document.body.style.overflow = "hidden";
    overlay.classList.remove("pointer-events-none");
    overlay.classList.add("opacity-100");
    if (input) {
      input.value = "";
      setTimeout(() => input.focus(), 10);
    }
    cards.forEach((card) => {
      card.style.display = "";
    });
    if (countEl) {
      countEl.textContent = String(cards.length);
    }
    if (emptyEl) {
      emptyEl.classList.add("hidden");
    }
  }

  function closeSearch() {
    if (!overlay) return;
    document.body.style.overflow = ""
    overlay.classList.add("pointer-events-none");
    overlay.classList.remove("opacity-100");
  }

  document.querySelectorAll("[data-open-search]").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      openSearch();
    });
  });

  // Fermeture via le bouton "Échap" (l'icône croix/bouton texte)
  overlay
    ?.querySelector("[data-search-close]")
    ?.addEventListener("click", () => closeSearch());

  overlay?.addEventListener("click", (e) => {
    if (container && !container.contains(e.target)) {
      closeSearch();
    }
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeSearch();
    }
  });

  function updateSearch() {
    if (!input) return;
    const q = input.value.trim().toLowerCase();
    let visible = 0;

    cards.forEach((card) => {
      const text = (card.dataset.search || "").toLowerCase();
      const show = !q || text.includes(q);
      card.style.display = show ? "" : "none";
      if (show) visible++;
    });

    if (countEl) {
      countEl.textContent = String(visible);
    }
    if (emptyEl) {
      emptyEl.classList.toggle("hidden", visible !== 0);
    }
  }

  input?.addEventListener("input", updateSearch);
</script>