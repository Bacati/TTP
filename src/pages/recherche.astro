---
import MainLayout from "layouts/MainLayout.astro";

const q = Astro.url.searchParams.get("q") ?? "";
---

<MainLayout title={`Recherche${q ? " · " + q : ""}`}>
  <h1>Résultats</h1>

  <form id="search-form" role="search" aria-label="Recherche produits" style="margin:.75rem 0;">
    <input type="search" name="q" placeholder="Rechercher…" value={q} autocomplete="off" style="width:100%;padding:.7rem 1rem;" />
    <label style="display:block;margin-top:.5rem;">
      <input id="orMode" type="checkbox" /> Mode "OU" (élargir la recherche)
    </label>
  </form>

  <div id="filters" style="margin:.75rem 0;"></div>
  <div id="results" aria-live="polite"></div>

  <style>
    .grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); margin-top: 1rem; }
    .product { border: 1px solid #eee; border-radius: 12px; overflow: hidden; background: #fff; }
    .wrap { display: grid; grid-template-rows: 160px 1fr; text-decoration: none; color: inherit; }
    .wrap img { width: 100%; height: 160px; object-fit: cover; background: #f6f6f6; }
    .meta { padding: .8rem 1rem 1rem; }
    .brand { opacity: .7; margin:.2rem 0; }
    .price { font-weight: 700; margin:.2rem 0; }
    .src { font-size: .8rem; opacity:.6; }
  </style>

  <script type="module">
    import { buildIndex } from "/src/lib/searchIndex.ts";
    import { searchProducts } from "/src/lib/search.ts";

    const RESULTS = document.getElementById("results");
    const FILTERS = document.getElementById("filters");
    const INPUT = document.querySelector('#search-form input[name="q"]');
    const ORMODE = document.getElementById("orMode");

    const INDEX = buildIndex();

    // Filtres par source (competition, alldays, accessoires…)
    const groups = Array.from(new Set(INDEX.map(p => p.group)));
    FILTERS.innerHTML = `
      <strong>Sources:</strong>
      ${groups.map(g => `
        <label style="margin-right:.75rem;">
          <input type="checkbox" name="grp" value="${g}" checked> ${g}
        </label>
      `).join("")}
    `;
    function selectedGroups() {
      return [...document.querySelectorAll('input[name="grp"]:checked')].map(i => i.value);
    }

    function render(items, q) {
      if (!q) { RESULTS.innerHTML = `<p>Tape un mot-clé.</p>`; return; }
      if (!items.length) { RESULTS.innerHTML = `<p>Aucun produit pour « <strong>${q}</strong> ».</p>`; return; }
      RESULTS.innerHTML = `
        <p>${items.length} résultat${items.length>1?'s':''} pour « <strong>${q}</strong> »</p>
        <section class="grid">
          ${items.map(p => `
            <article class="product">
              <a href="${p.url}" class="wrap" target="${p.url.startsWith('http') ? '_blank' : '_self'}" rel="noopener">
                ${p.image ? `<img src="${p.image}" alt="${p.title}" loading="lazy">` : ""}
                <div class="meta">
                  <h2>${p.title}</h2>
                  ${p.brand ? `<p class="brand">${p.brand}</p>` : ""}
                  ${p.price ? `<p class="price">${p.price}</p>` : ""}
                  ${p.group ? `<p class="src">Source : ${p.group}${p.categoryLabel ? " · " + p.categoryLabel : ""}</p>` : ""}
                </div>
              </a>
            </article>
          `).join("")}
        </section>
      `;
    }

    let t;
    function run() {
      const q = INPUT.value.trim();
      const opts = { groups: selectedGroups(), orMode: ORMODE.checked };
      const items = searchProducts(INDEX, q, opts);
      render(items, q);

      const url = new URL(location.href);
      q ? url.searchParams.set("q", q) : url.searchParams.delete("q");
      history.replaceState(null, "", url);
    }

    INPUT.addEventListener("input", () => { clearTimeout(t); t = setTimeout(run, 150); });
    FILTERS.addEventListener("change", run);
    ORMODE.addEventListener("change", run);
    run();
  </script>
</BaseLayout>
