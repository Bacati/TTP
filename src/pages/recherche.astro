---
import MainLayout from "layouts/MainLayout.astro";
import { allProducts, type Product } from "../libs/allProducts";
import Cards from "components/global/Cards.astro";

const products: Product[] = allProducts;

const buildSearchData = (p: Product) =>
  [
    p.title,
    p.alt,
    p.altlogo,
    p.description,
    p.typeMotor,
    p.typeMotor1,
    p.source,
    p.categoryId,
  ]
    .filter(Boolean)
    .join(" ")
    .toLowerCase();

const getProductHref = (p: Product) => {
  if (!p.configKey) return undefined;

  // 1) Lien externe (Amazon, MyCover, Flush...)
  if (p.configKey.startsWith("http")) {
    return p.configKey;
  }

  // 2) Config AllDays
  if (p.source === "config-allDays") {
    return `/product/config?config=${encodeURIComponent(
      p.configKey
    )}#item-1`;
  }

  // 3) Config CompÃ©tition
  if (p.source === "config-competition") {
    return `/product/config?configCompetition=${encodeURIComponent(
      p.configKey
    )}#item-1`;
  }

  // 4) Fiche produit interne
  if (p.source === "produit") {
    return `/product/produit?produit=${encodeURIComponent(p.configKey)}`;
  }

  // Fallback : on traite comme une fiche produit interne
  return `/product/produit?produit=${encodeURIComponent(p.configKey)}`;
};

const isExternal = (p: Product) =>
  !!p.configKey && p.configKey.startsWith("http");
---

    <MainLayout>
		<div class="h-96"></div>
      <h1>Rechercher un produit</h1>

      <div class="search-bar">
        <input
          id="search-input"
          class="search-input"
          type="text"
          placeholder="Tape un nom de produit, une marque, une config (ex : 70cc, Bidalot, Airsal)..."
        />
      </div>

      <div class="search-meta">
        <span id="search-count">
          {products.length} produit{products.length > 1 ? "s" : ""} disponible
          sur le site
        </span>
      </div>

	  <div id="results" class="flex gap-8 justify-center flex-wrap">
		{products.map((p) => {
		  const searchData = buildSearchData(p);
	  
		  const imageSrc = p.image
			? `/images/${p.image}`
			: "/images/moteur.png"; // fallback si tu veux
	  
		  const logoSrc = p.logo
			? (p.logo.startsWith("/images") ? p.logo : `/images/${p.logo}`)
			: "/images/logo2.svg";
	  
		  const lien = getProductHref(p);
		  const external = isExternal(p);
	  
		  return (
			<article class="product-card" data-search={searchData}>
			  <Cards
				title={p.title}
				description={p.description ?? ""}
				price={p.price && p.price !== "N/A" ? p.price : undefined}
				imageSrc={imageSrc}
				lien={lien}
				logo={logoSrc}
				typeMotor={p.typeMotor}
				typeMotor1={p.typeMotor1}
				alt={p.alt ?? p.title}
				altLogo={p.altlogo ?? p.alt ?? p.title}
				external={external}
			  />
			</article>
		  );
		})}
		 <article
		 class="product-card"
		 data-search="esthÃ©tique custom kit dÃ©co dÃ©co perso peinture impression 3d carbone gxs lmr of carbon tuning design"
	   >
		 <div class="product-header">
		   <div class="product-logo">
			 <img src="/images/pedroni.jpeg" alt="Page esthÃ©tique" />
		   </div>
		   <div>
			 <div class="product-title">Page EsthÃ©tique</div>
			 <div class="product-meta">
			   CatÃ©gorie Â· Personnalisation / kits dÃ©co / carbone
			 </div>
		   </div>
		 </div>
	 
		 <div class="product-image">
		   <img src="/images/pedroni.jpeg" alt="EsthÃ©tique moto" loading="lazy" />
		 </div>
	 
		 <div class="product-bottom">
		   <div>
			 <div class="product-source">page</div>
		   </div>
	 
		   <!-- ğŸ”— adapte le lien Ã  la vraie route de ta page -->
		   <a href="/categorie/esthetique" class="product-link">
			 Voir la page
			 <span>â†—</span>
		   </a>
		 </div>
	   </article>
	   <article
	   class="product-card"
	   data-search="equipement casque gants blouson bottes combinaison protection tenue cross sÃ©curitÃ©"
	 >
	   <div class="product-header">
		 <div class="product-logo">
		   <img src="/images/equipement.webp" alt="Page Equipement" />
		 </div>
		 <div>
		   <div class="product-title">Page Ã‰quipement</div>
		   <div class="product-meta">
			 CatÃ©gorie Â· Casques, gants, blousons, bottes...
		   </div>
		 </div>
	   </div>
   
	   <div class="product-image">
		 <img src="/images/equipement.webp" alt="Ã‰quipement moto" loading="lazy" />
	   </div>
   
	   <div class="product-bottom">
		 <div>
		   <div class="product-source">page</div>
		 </div>
   
		 <!-- ğŸ”— adapte aussi cette route -->
		 <a href="/product/equipement" class="product-link">
		   Voir la page
		   <span>â†—</span>
		 </a>
	   </div>
	 </article>
	 <article
  class="product-card"
  data-search="gxs kit dÃ©co kit deco perso holographique chrome esthÃ©tique"
>
  <div class="product-header">
    <div class="product-logo">
      <img src="/images/gxs.jpg" alt="GXS Racing" />
    </div>
    <div>
      <div class="product-title">Kits dÃ©cos -10% (GXS Racing)</div>
      <div class="product-meta">Partenaire Â· EsthÃ©tique</div>
    </div>
  </div>

  <div class="product-image">
    <img src="/images/yoni.png" alt="Kit dÃ©co GXS" loading="lazy" />
  </div>

  <div class="product-bottom">
    <div>
      <div class="product-source">partenaire</div>
    </div>

    <a
      href="https://gxs-racing.com/fr/?refs=8350"
      class="product-link"
      target="_blank"
      rel="noreferrer"
    >
      Voir le site
      <span>â†—</span>
    </a>
  </div>
</article>

      </div>

      <p id="no-results" class="no-results" style="display:none;">
        Aucun produit ne correspond Ã  ta recherche. Essaie avec un autre mot
        (par exemple : â€œAirsalâ€, â€œBidalotâ€, â€œclignotantâ€, â€œentretienâ€...).
      </p>

      <script>
        const input = document.querySelector("#search-input");
        const cards = Array.from(
          document.querySelectorAll(".product-card")
        );
        const countEl = document.querySelector("#search-count");
        const noResultsEl = document.querySelector("#no-results");

        function updateSearch() {
          const q = input.value.trim().toLowerCase();
          let visible = 0;

          cards.forEach((card) => {
            const text = card.dataset.search || "";
            const show = !q || text.includes(q);
            card.style.display = show ? "" : "none";
            if (show) visible++;
          });

          if (countEl) {
            countEl.textContent =
              visible +
              " produit" +
              (visible > 1 ? "s" : "") +
              (q ? " trouvÃ©(s)" : " disponible sur le site");
          }

          if (noResultsEl) {
            noResultsEl.style.display = visible === 0 ? "" : "none";
          }
        }

        input?.addEventListener("input", updateSearch);
      </script>
    </main>
  </body>
</html>
